generator client {
  provider = "prisma-client-py"
  interface = "asyncio"
  recursive_type_depth = 5
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String?  // Hashed, nullable for OAuth users
  name      String?
  avatar    String?
  provider  String   @default("email") // "email", "google"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  sessions  StudySession[]
  subjects  Subject[]
  flashcards Flashcard[]
  tasks     Task[]
  semesterConfig SemesterConfig?
  memory    UserMemory?
  wellbeingLog UserWellbeing[]
  materials Material[]
}

model UserMemory {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  user            User     @relation(fields: [userId], references: [id])
  weakConcepts    String   @default("[]") // JSON array
  strongConcepts  String   @default("[]") // JSON array
  preferences     String   @default("{}") // JSON object
  focusScore      Int      @default(70)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}


model Subject {
  id        Int      @id @default(autoincrement())
  name      String
  color     String   @default("#000000")
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  sessions  StudySession[]
  flashcards Flashcard[]
  tags      Tag[]
  tasks     Task[]
  exams     Exam[]
  materials Material[]
  concepts  Concept[]
  
  // Smart Planner Metadata
  priority    Int      @default(1) // 1: Normal, 2: High, 3: Core (20%)
  difficulty  Int      @default(5) // 1-10 (Perceived difficulty)
  targetGrade String?  // e.g. "A", "90"
  
  semesterId  Int?
  semester    SemesterConfig? @relation(fields: [semesterId], references: [id])
}

model StudySession {
  id        Int      @id @default(autoincrement())
  startTime DateTime @default(now())
  endTime   DateTime?
  duration  Int?     // In minutes (Actual)
  plannedDuration Int? // In minutes (Target)
  isFocusMode Boolean @default(false)
  interruptions Int @default(0) // Number of pauses/interruptions
  
  // 1.2 Neural Fatigue
  cognitiveLoad String @default("MEDIUM") // "HIGH", "MEDIUM", "LOW"
  fatigueLevel  Int?   // 1-10 (Self-reported at end)
  
  subjectId Int
  subject   Subject  @relation(fields: [subjectId], references: [id])
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  notes     String?
}

model Flashcard {
  id        Int      @id @default(autoincrement())
  front     String
  back      String
  subjectId Int
  subject   Subject  @relation(fields: [subjectId], references: [id])
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  
  // FSRS fields
  stability Float    @default(0)
  difficulty Float   @default(0)
  elapsedDays Float  @default(0)
  scheduledDays Float @default(0)
  reps      Int      @default(0)
  lapses    Int      @default(0)
  state     Int      @default(0) // 0: New, 1: Learning, 2: Review, 3: Relearning
  lastReview DateTime?
  due       DateTime @default(now())
  
  tags      Tag[]
  reviews   FlashcardReview[]
}

model Tag {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  subjects  Subject[]
  flashcards Flashcard[]
  concepts   Concept[] @relation("ConceptTags")
}

model Task {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  isCompleted Boolean  @default(false)
  dueDate     DateTime?
  priority    Int      @default(0) // 0: None, 1: Low, 2: Medium, 3: High
  
  subjectId   Int?
  subject     Subject? @relation(fields: [subjectId], references: [id])
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model SemesterConfig {
  id              Int      @id @default(autoincrement())
  userId          Int      @unique
  user            User     @relation(fields: [userId], references: [id])
  semesterName    String   // e.g., "Fall 2024"
  startDate       DateTime
  endDate         DateTime
  weeklyStudyHours Int     // Available hours per week
  learningStyle   String?  // "visual", "reading", "practice", etc.
  subjects        Subject[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Exam {
  id          Int      @id @default(autoincrement())
  subjectId   Int
  subject     Subject  @relation(fields: [subjectId], references: [id])
  examType    String   // "midterm", "final", "quiz"
  examDate    DateTime
  weight      Int      @default(0) // Percentage weight (0-100)
  topics      String?  // JSON array of topics
  createdAt   DateTime @default(now())
  
  // Chapters to study for this exam
  startChapter Int?
  endChapter   Int?
  textbookId   Int?
  textbook     Textbook? @relation(fields: [textbookId], references: [id])
  studyPlans   StudyPlan[]
}

model Textbook {
  id          Int      @id @default(autoincrement())
  title       String
  subjectId   Int
  totalChapters Int    @default(10)
  chapters    Chapter[]
  exams       Exam[]
  createdAt   DateTime @default(now())
}

model Chapter {
  id          Int      @id @default(autoincrement())
  textbookId  Int
  textbook    Textbook @relation(fields: [textbookId], references: [id])
  number      Int      // Chapter number
  title       String
  importance  Float    @default(0.5) // 0-1, for 80/20 rule priority
  estimatedHours Float @default(2)   // Estimated study hours
  concepts    String   @default("[]") // JSON array of key concepts
  isCore      Boolean  @default(false) // True if this is a "20%" core chapter
}

model StudyPlan {
  id          Int      @id @default(autoincrement())
  examId      Int
  exam        Exam     @relation(fields: [examId], references: [id])
  weekNumber  Int      // Week of the plan (1, 2, 3...)
  weekStart   DateTime
  weekEnd     DateTime
  chaptersToStudy String @default("[]") // JSON array of chapter IDs
  totalHours  Float    // Target hours for this week
  priority    String   // "core" (20%), "support" (30%), "detail" (50%)
  tasks       String   @default("[]") // JSON array of specific tasks
  isCompleted Boolean  @default(false)
  createdAt   DateTime @default(now())
}

// ðŸ§  Neuroscience & Cognitive Science Extensions

// 1.1 Memory Consolidation & Emotion Check-in
model UserWellbeing {
  id          Int      @id @default(autoincrement())
  userId      Int
  date        DateTime @default(now())
  sleepHours  Float?
  sleepQuality Int?    // 1-10
  stressLevel Int?     // 1-10
  mood        String?  // Text description or enum
  energyLevel Int?     // 1-10 (For neural fatigue tracking)
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
}

// 2.4 Knowledge Structure (Schema Formation)
model Concept {
  id          Int      @id @default(autoincrement())
  name        String
  subjectId   Int
  subject     Subject  @relation(fields: [subjectId], references: [id])
  importance  Float    @default(0.5) // 80-20 Rule weight
  tags        Tag[]    @relation("ConceptTags")
  
  // Relations to other concepts
  outgoing    ConceptRelation[] @relation("source")
  incoming    ConceptRelation[] @relation("target")
  
  description String?
  createdAt   DateTime @default(now())
}

model ConceptRelation {
  id        Int     @id @default(autoincrement())
  sourceId  Int
  source    Concept @relation("source", fields: [sourceId], references: [id])
  targetId  Int
  target    Concept @relation("target", fields: [targetId], references: [id])
  type      String  // "PREREQUISITE", "RELATED", "PART_OF"
  strength  Float   @default(0.5) 
}

// 2.3 Metacognitive Calibration
model FlashcardReview {
  id          Int      @id @default(autoincrement())
  flashcardId Int
  flashcard   Flashcard @relation(fields: [flashcardId], references: [id])
  
  rating      Int      // FSRS rating (1-4)
  confidence  Int?     // 0-100% Pre-answer confidence
  actualResult Boolean // True/False
  calibrationErr Int?  // confidence - normalized_score (0-100)
  
  duration    Int      // milliseconds
  reviewedAt  DateTime @default(now())
}

model Material {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  subjectId Int?
  subject   Subject? @relation(fields: [subjectId], references: [id])
  
  title     String
  type      String   // "pdf", "md", "txt"
  url       String   // Local path 
  
  // RAG Metadata
  isIndexed Boolean  @default(false)
  chunkCount Int     @default(0)
  
  createdAt DateTime @default(now())
}

